
# .github/workflows/claude-code.yml
name: "üîçüõ°Ô∏è Audit & Optimisation Totale (Claude 4 Code)"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:   # lancement manuel au besoin

permissions:
  contents: write          # pour committer les corrections
  pull-requests: write     # pour ouvrir / mettre √† jour des PR

jobs:
  claude-full-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Claude 4 Code ‚Äì Analyse & Corrections
        uses: anthropics/claude-code-action@beta   # action officielle
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token:      ${{ secrets.GITHUB_TOKEN }}

          # Prompt inject√© automatiquement sans @mention
          direct_prompt: |
            Tu es Claude 4 Code, expert senior Android/iOS.
            Objectifs :
            1. Analyse exhaustive du d√©p√¥t : architecture, d√©pendances, vuln√©rabilit√©s.
            2. Cibler Android 13‚Üí15, pr√©parer portage iOS (Swift/Kotlin Multiplatform).
            3. Corriger toutes les erreurs de lint, build ou test.
            4. Renforcer la s√©curit√© (OWASP Mobile + Android Vulnerabilities), √©liminer XSS, SQLi, mauvaise gestion TLS.
            5. Optimiser performances (taille APK/AAB, threads, battery, r√©seau).
            6. Si n√©cessaire, r√©√©cris ou refactorise le code pour atteindre la conformit√© et la qualit√© maximale.
            7. G√©n√©re les tests unitaires et instrument√©s manquants.
            8. Pousse les modifications dans une branche `fix/claude-auto` et ouvre/actualise la PR associ√©e.
            9. Continue jusqu‚Äô√† ce que tous les check-lists soient coch√©s ou qu‚Äôaucune t√¢che ne reste.

          model: claude-4-code   # assure l‚Äôusage du mod√®le de derni√®re g√©n√©ration
          timeout_minutes: 120   # prolonge la session si besoin

          # Habilitations bash explicites
          allowed_tools: |
            Bash(./gradlew lint),
            Bash(./gradlew detekt),
            Bash(./gradlew test),
            Bash(./gradlew assembleRelease),
            Edit,Replace

          # Emp√™che tout outil risqu√©
          disallowed_tools: "TaskOutput,KillTask"

      - name: Rapport final (facultatif)
        if: always()
        run: echo "Analyse compl√®te ex√©cut√©e par Claude."
